#!/usr/bin/env node
/**
 * Computes intersection for two feature geojson objects.
 *
 * Accepts one geojson feature collection object via standard in.
 * Uses turf.intersect() under the hood for the heavy lifting.
 *
 * The turf docs (http://turfjs.org/docs/#intersect) claim that
 * only Polygons are allowed - but appears to me to be taking
 * MultiPolygons just fine as input (2017/09/28).
 */

const process = require('process')
const turf = require('turf')

process.stdin.setEncoding('utf-8')

let input = ''
process.stdin.on('readable', () => {
  let chunk
  while ((chunk = process.stdin.read())) {
    input += chunk
  }
})

process.stdin.on('end', () => {
  const jsons = parseOutTwoJsons(input)
  const jsonOut = jsons.reduce(turf.intersect)
  writeOutput(jsonOut)
})

function parseOutTwoJsons (inputStr) {
  let jsonIn
  try {
    jsonIn = JSON.parse(inputStr)
  } catch (err) {
    throw Error('Unable to parse geojson from stdin')
  }
  if (jsonIn.type !== 'FeatureCollection') {
    throw Error('Input geojson must be of type FeatureCollection')
  }
  return jsonIn.features
}

function writeOutput (jsonOut) {
  if (jsonOut) {
    const strOut = JSON.stringify(jsonOut)
    process.stdout.write(strOut)
  }
}
